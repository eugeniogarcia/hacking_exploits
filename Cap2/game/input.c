#include <fcntl.h>
#include "game_of_chance.h"
#include <sys/stat.h>
#include <stdlib.h>
#include <stdio.h>

// This function is used to input the player name, since
// scanf("%s", &whatever) will stop input at the first space.
void input_name()
{
    char *name_ptr, input_char = '\n';

    while (input_char == '\n')    // Flush any leftover
        scanf("%c", &input_char); // newline chars.

    name_ptr = (char *)&(player.name); // name_ptr = player name's address

    while (input_char != '\n')
    {                             // Loop until newline.
        *name_ptr = input_char;   // Put the input char into name field.
        scanf("%c", &input_char); // Get the next char.

        name_ptr++; // Increment the name pointer.
    }
    *name_ptr = 0; // Terminate the string.
}

// This is the new user registration function.
// It will create a new player account and append it to the file.
void register_new_player()
{
    int fd;
    printf("-=-={ New Player Registration }=-=-\n");
    printf("Enter your name: ");
    input_name();

    player.uid = getuid();
    player.highscore = player.credits = 100;

    fd = open(DATAFILE, O_WRONLY | O_CREAT | O_APPEND, S_IRUSR | S_IWUSR);
    if (fd == -1)
        fatal("in register_new_player() while opening file");

    write(fd, &player, sizeof(struct user));
    close(fd);

    printf("\nWelcome to the Game of Chance %s.\n", player.name);
    printf("You have been given %u credits.\n", player.credits);
}

// This function reads the player data for the current uid
// from the file. It returns -1 if it is unable to find player
// data for the current uid.
int get_player_data()
{
    int fd, uid, read_bytes;
    struct user entry;
    uid = getuid();
    fd = open(DATAFILE, O_RDONLY);
    if (fd == -1) // Can't open the file, maybe it doesn't exist
        return -1;

    read_bytes = read(fd, &entry, sizeof(struct user)); // Read the first chunk.
    while (entry.uid != uid && read_bytes > 0)
    {                                                       // Loop until proper uid is found.
        read_bytes = read(fd, &entry, sizeof(struct user)); // Keep reading.
    }

    close(fd); // Close the file.

    if (read_bytes < sizeof(struct user)) // This means that the end of file was reached.
        return -1;
    else
        player = entry; // Copy the read entry into the player struct.
    return 1;           // Return a success.
}

// This function writes the current player data to the file.
// It is used primarily for updating the credits after games.
void update_player_data()
{
    int fd, i, read_uid;
    char burned_byte;
    fd = open(DATAFILE, O_RDWR);
    if (fd == -1) // If open fails here, something is really wrong.
        fatal("in update_player_data() while opening file");

    read(fd, &read_uid, 4); // Read the uid from the first struct.
    while (read_uid != player.uid)
    {                                                 // Loop until correct uid is found.
        for (i = 0; i < sizeof(struct user) - 4; i++) // Read through the
            read(fd, &burned_byte, 1);                // rest of that struct.
        read(fd, &read_uid, 4);                       // Read the uid from the next struct.
    }

    write(fd, &(player.credits), 4);   // Update credits.
    write(fd, &(player.highscore), 4); // Update highscore.
    write(fd, &(player.name), 100);    // Update name.
    close(fd);
}

// This function will display the current high score and
// the name of the person who set that high score.
void show_highscore()
{
    unsigned int top_score = 0;
    char top_name[100];
    struct user entry;
    int fd;

    printf("\n====================| HIGH SCORE |====================\n");
    fd = open(DATAFILE, O_RDONLY);
    if (fd == -1)
        fatal("in show_highscore() while opening file");
    
    while (read(fd, &entry, sizeof(struct user)) > 0)
    { // Loop until end of file.
        if (entry.highscore > top_score)
        {                                 // If there is a higher score,
            top_score = entry.highscore;  // set top_score to that score
            strcpy(top_name, entry.name); // and top_name to that username.
        }
    }
    
    close(fd);
    if (top_score > player.highscore)
        printf("%s has the high score of %u\n", top_name, top_score);
    else
        printf("You currently have the high score of %u credits!\n", player.highscore);
    printf("======================================================\n\n");
}